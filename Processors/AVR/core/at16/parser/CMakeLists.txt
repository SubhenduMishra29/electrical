#parser/cmake
# Specify the minimum version of CMake
cmake_minimum_required(VERSION 3.10)

# Project name for the parser
project(ParserProject)

# Find Flex and Bison packages
find_package(FLEX REQUIRED)
find_package(BISON REQUIRED)
# Set the path to the Flex library
set(FLEX_LIBRARY "C:/msys64/usr/lib/libfl.a")
# Define the Flex and Bison input files
set(FLEX_INPUT "${CMAKE_CURRENT_SOURCE_DIR}/lexer.l")
set(BISON_INPUT "${CMAKE_CURRENT_SOURCE_DIR}/parser.y")

# Output files generated by Flex and Bison
set(BISON_OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/parser.tab.c")
set(FLEX_OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/lexer.yy.c")

# Run Bison to generate the parser and its header file
BISON_TARGET(Parser ${BISON_INPUT} ${BISON_OUTPUT} COMPILE_FLAGS "--defines=${CMAKE_CURRENT_BINARY_DIR}/parser.tab.h")

# Run Flex to generate the lexer
FLEX_TARGET(Lexer ${FLEX_INPUT} ${FLEX_OUTPUT})

# Ensure that Flex and Bison outputs go into the build directory
add_library(ParserLib OBJECT ${BISON_OUTPUT} ${FLEX_OUTPUT})

# Ensure that ParserLib object files are compiled to the build directory
set_target_properties(ParserLib PROPERTIES
    ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/at16/parser"
    LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/at16/parser"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/at16/parser"
)

# Include directories for using parser.tab.h
target_include_directories(ParserLib PUBLIC ${CMAKE_CURRENT_BINARY_DIR}${FLEX_LIBRARY})
